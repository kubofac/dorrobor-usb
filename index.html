<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPSè¨­å®šãƒ„ãƒ¼ãƒ«</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="manifest" href="/manifest.json">
    <style>
        /* åœ°å›³ã‚³ãƒ³ãƒ†ãƒŠã®ç›¸å¯¾ä½ç½®æŒ‡å®š */
        #map-container {
            position: relative;
        }

        /* åœ°å›³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #mapid {
            height: 300px;
            width: 100%;
            margin-bottom: 15px;
        }

        /* åœ°å›³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
        }

        /* åœ°å›³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«å†…ã®ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #map-controls button {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            margin-right: 5px;
        }

        /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #map-controls button.active {
            background-color: #007bff;
            color: white;
        }

        /* bodyå…¨ä½“ã®ãƒ•ã‚©ãƒ³ãƒˆã¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .form-group {
            margin-bottom: 15px;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®ãƒ©ãƒ™ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        /* æ•°å€¤å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .form-group input[type="number"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 16px;
            width: 200px;
        }

        /* ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .form-group select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 16px;
            width: 200px;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .form-group button {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 16px;
            cursor: pointer;
            margin-right: 5px;
        }

        /* å„ç¨®è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #setSportkk,
        #setSportkkk,
        #setThresholdValue,
        #setLapCoolDown,
        #gps-frequency {
            margin-top: 10px;
            font-weight: bold;
        }

        /* ã‚¯ãƒªãƒƒã‚¯åº§æ¨™è¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #clickCoordinates {
            font-weight: bold;
        }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #instructionMessage {
            font-weight: bold;
            min-height: 20px;
        }
    </style>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js')
      .then(registration => {
        console.log('Service Worker registered! Scope:', registration.scope);
      })
      .catch(err => {
        console.log('Service Worker registration failed:', err);
      });
  });
}
</script>


</head>
<body>

    <div class="form-group">
        <label for="circuitSelect">ã‚µãƒ¼ã‚­ãƒƒãƒˆã‚’é¸æŠ:</label>
        <select name="cir" id="circuitSelect">
            <option value="">ã‚µãƒ¼ã‚­ãƒƒãƒˆã‚’é¸æŠ</option>
            <option value="0">ç™½ç³¸S</option>
            <option value="1">å¯Œå£«C</option>
            <option value="2">ã¤ã¾æ‹</option>
            <option value="3">ä¸­äº•C</option>
        </select>
        <p id="setSportkk"></p>
    </div>

    <div id="map-container">
        <div id="mapid"></div>
        <div id="map-controls">
            <button id="setStartPointButton">é–‹å§‹ç‚¹ã‚’é…ç½®</button>
            <button id="setEndPointButton" disabled>çµ‚äº†ç‚¹ã‚’é…ç½®</button>
        </div>
    </div>
    
    <div class="form-group">
        <p id="instructionMessage"></p>
    </div>

    <div class="form-group">
        <label for="startLineP1Lon">é–‹å§‹ç‚¹ çµŒåº¦:</label>
        <input type="number" id="startLineP1Lon" placeholder="çµŒåº¦" readonly>
    </div>
    <div class="form-group">
        <label for="startLineP1Lat">é–‹å§‹ç‚¹ ç·¯åº¦:</label>
        <input type="number" id="startLineP1Lat" placeholder="ç·¯åº¦" readonly>
    </div>
    <div class="form-group">
        <label for="startLineP2Lon">çµ‚äº†ç‚¹ çµŒåº¦:</label>
        <input type="number" id="startLineP2Lon" placeholder="çµŒåº¦" readonly>
    </div>
    <div class="form-group">
        <label for="startLineP2Lat">çµ‚äº†ç‚¹ ç·¯åº¦:</label>
        <input type="number" id="startLineP2Lat" placeholder="ç·¯åº¦" readonly>
    </div>

    <div class="form-group">
        <button onclick="saveStartLineCoordinates()">ã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³åº§æ¨™ã‚’ä¿å­˜</button>
    </div>

    <div class="form-group">
        <p>GPSæ›´æ–°é »åº¦: <span id="gps-frequency">è¨ˆæ¸¬ä¸­...</span> Hz</p>
    </div>

    <div class="form-group">
        <label for="pulseCountSelect">ãƒ‘ãƒ«ã‚¹æ•°:</label>
        <select name="pl" id="pulseCountSelect">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="4">4</option>
        </select>
        <p id="setSportkkk"></p>
    </div>

    <div class="form-group">
        <button onclick="savePulseCount()">SET ãƒ‘ãƒ«ã‚¹æ•°</button>
    </div>

    <div class="form-group">
        <label for="thresholdSelect">GPSé–¾å€¤ (ãƒ¡ãƒ¼ãƒˆãƒ«):</label>
        <select name="threshold" id="thresholdSelect">
            <option value="10">10m</option>
            <option value="15">15m</option>
            <option value="20">20m</option>
            <option value="25">25m</option>
            <option value="30">30m</option>
            <option value="40">40m</option>
        </select>
        <p id="setThresholdValue"></p>
    </div>

    <div class="form-group">
        <button onclick="saveThreshold()">SET GPSé–¾å€¤</button>
    </div>

    <div class="form-group">
        <label for="lapCoolDownSelect">ãƒ©ãƒƒãƒ—ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ (ç§’):</label>
        <select name="coolDown" id="lapCoolDownSelect">
            <option value="20000">20ç§’</option>
            <option value="30000">30ç§’</option>
            <option value="40000">40ç§’</option>
            <option value="50000">50ç§’</option>
            <option value="60000">60ç§’</option>
            <option value="90000">90ç§’</option>
            <option value="122000">120ç§’</option>
            <option value="180000">180ç§’</option>
        </select>
        <p id="setLapCoolDown"></p>
    </div>

    <div class="form-group">
        <button onclick="saveLapCoolDown()">SET ãƒ©ãƒƒãƒ—ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³</button>
    </div>



Â  Â  <div class="form-group">
Â  Â  Â  Â  <h3>ğŸ“¡ NMEA/USBãƒ‡ãƒã‚¤ã‚¹è¨­å®š (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</h3>
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="vendorId">NMEA VENDOR ID (ä¾‹: 0x1A86):</label>
Â  Â  Â  Â  <input type="text" id="vendorId" placeholder="ä¾‹: 0x1A86">
Â  Â  </div>
Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="productId">NMEA PRODUCT ID (ä¾‹: 0x7523):</label>
Â  Â  Â  Â  <input type="text" id="productId" placeholder="ä¾‹: 0x7523">
Â  Â  Â  Â  <small>â€»IDã¯16é€²æ•°è¡¨è¨˜ã§å…¥åŠ›ã—ã¦ãã ã•ã„</small>
Â  Â  </div>
Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="interfaceNumber">INTERFACE NUMBER (ä¾‹: 0):</label>
Â  Â  Â  Â  <input type="number" id="interfaceNumber" placeholder="ä¾‹: 0">
Â  Â  </div>
Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="inEndpoint">IN ENDPOINT (ä¾‹: 1):</label>
Â  Â  Â  Â  <input type="number" id="inEndpoint" placeholder="ä¾‹: 1">
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <button onclick="saveNmeaSettings()">NMEA/USBè¨­å®šã‚’ä¿å­˜</button>
Â  Â  </div>
Â  Â  <div class="form-group">
Â  Â  Â  Â  <p id="setNmeaSettings"></p>
Â  Â  </div>














    <div class="form-group">
        <button value="START" id="mybtn2">START</button>
    </div>

    <div class="form-group">
        <p id="clickCoordinates"></p>
    </div>

    <div class="form-group">
        <button id="resetStorageButton">Reset All Settings</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="circuit_data.js"></script>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        var map;
        var startPointMarker = null;
        var endPointMarker = null;
        var currentPositionMarker = null;
        var startLinePolyline = null; // ã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³ã®ç·š
        var pl1 = 1; // ãƒ‘ãƒ«ã‚¹æ•°
        var cir1 = ""; // ã‚µãƒ¼ã‚­ãƒƒãƒˆå
        var gpsThreshold = 20; // GPSé–¾å€¤ã®åˆæœŸå€¤
        var lapCoolDownTime = 30000; // ãƒ©ãƒƒãƒ—ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æ™‚é–“ã®åˆæœŸå€¤ (ãƒŸãƒªç§’)

        // GPSæ›´æ–°é »åº¦è¨ˆæ¸¬ç”¨ã®å¤‰æ•°
        let lastTimestamp = 0;
        let watchId = null;

        // åœ°å›³ã®åˆæœŸåŒ–ï¼ˆç¾åœ¨ä½ç½®ã‚’ä½¿ç”¨ï¼‰
        function initMap() {
            map = L.map('mapid');
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // åœ°å›³ã®åˆæœŸä½ç½®ã‚’é©å½“ãªå ´æ‰€ã«è¨­å®šï¼ˆwatchPositionã§æ›´æ–°ã•ã‚Œã‚‹ï¼‰
            map.setView([35.0, 139.0], 8);
        }

        // GPSã®æ›´æ–°é »åº¦ã¨ç¾åœ¨ä½ç½®ã‚’ç›£è¦–ã™ã‚‹é–¢æ•°
        function startGpsFrequencyMonitor() {
            // watchPosition ã®æˆåŠŸæ™‚ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
            function watchSuccess(position) {
                const currentTimestamp = position.timestamp;
                
                // æœ€åˆã®ãƒ‡ãƒ¼ã‚¿å—ä¿¡æ™‚ä»¥å¤–
                if (lastTimestamp !== 0) {
                    const elapsedTime = currentTimestamp - lastTimestamp;
                    // æ›´æ–°é »åº¦ï¼ˆHzï¼‰ã‚’è¨ˆç®—ã—ã€è¡¨ç¤º
                    const frequency = 1000 / elapsedTime;
                    document.getElementById('gps-frequency').textContent = frequency.toFixed(2);
                }
                
                lastTimestamp = currentTimestamp;

                // åœ°å›³ä¸Šã®ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°
                const currentLatLng = L.latLng(position.coords.latitude, position.coords.longitude);
                if (currentPositionMarker) {
                    currentPositionMarker.setLatLng(currentLatLng);
                } else {
                    currentPositionMarker = L.marker(currentLatLng).addTo(map);
                    map.setView(currentLatLng, 16); // åˆå›å–å¾—æ™‚ã«ã‚ºãƒ¼ãƒ 
                }
            }

            // watchPosition ã®å¤±æ•—æ™‚ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
            function watchError(error) {
                console.error(`ä½ç½®æƒ…å ±ã®å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.code} - ${error.message}`);
                document.getElementById('gps-frequency').textContent = 'ã‚¨ãƒ©ãƒ¼';
            }

            // watchPosition ã§é€£ç¶šçš„ãªä½ç½®æƒ…å ±ã®ç›£è¦–ã‚’é–‹å§‹
            watchId = navigator.geolocation.watchPosition(watchSuccess, watchError, {
                // ã“ã“ã§ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            });
            console.log('GPSæ›´æ–°é »åº¦ã®ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚');
        }

        // ãƒãƒ¼ã‚«ãƒ¼ã®ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
        function onMarkerDragEnd(e) {
            const marker = e.target;
            const latlng = marker.getLatLng();

            if (marker === startPointMarker) {
                document.getElementById('startLineP1Lon').value = latlng.lng;
                document.getElementById('startLineP1Lat').value = latlng.lat;
                marker.setPopupContent('é–‹å§‹ç‚¹<br>ç·¯åº¦: ' + latlng.lat.toFixed(6) + '<br>çµŒåº¦: ' + latlng.lng.toFixed(6)).openPopup();
                console.log('é–‹å§‹ç‚¹ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦æ›´æ–°ã—ã¾ã—ãŸ:', latlng);
            } else if (marker === endPointMarker) {
                document.getElementById('startLineP2Lon').value = latlng.lng;
                document.getElementById('startLineP2Lat').value = latlng.lat;
                marker.setPopupContent('çµ‚äº†ç‚¹<br>ç·¯åº¦: ' + latlng.lat.toFixed(6) + '<br>çµŒåº¦: ' + latlng.lng.toFixed(6)).openPopup();
                console.log('çµ‚äº†ç‚¹ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦æ›´æ–°ã—ã¾ã—ãŸ:', latlng);
            }
            updateStartLinePolyline(); // ç·šã‚’æ›´æ–°
        }

        // ã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³ã®ç·šã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateStartLinePolyline() {
            if (startLinePolyline) {
                map.removeLayer(startLinePolyline);
            }
            if (startPointMarker && endPointMarker) {
                const p1 = startPointMarker.getLatLng();
                const p2 = endPointMarker.getLatLng();
                startLinePolyline = L.polyline([p1, p2], { color: 'red', weight: 5, opacity: 0.7 }).addTo(map);
            }
        }

        // ã€Œé–‹å§‹ç‚¹ã‚’é…ç½®ãƒ»ãƒ‰ãƒ©ãƒƒã‚°ã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('setStartPointButton').addEventListener('click', function() {
            if (!startPointMarker) {
                const center = map.getCenter();
                startPointMarker = L.marker(center, { draggable: true }).addTo(map);
                startPointMarker.on('dragend', onMarkerDragEnd);
                document.getElementById('startLineP1Lon').value = center.lng;
                document.getElementById('startLineP1Lat').value = center.lat;
                startPointMarker.bindPopup('é–‹å§‹ç‚¹<br>ç·¯åº¦: ' + center.lat.toFixed(6) + '<br>çµŒåº¦: ' + center.lng.toFixed(6)).openPopup();
            }
            map.setView(startPointMarker.getLatLng(), map.getZoom());
            document.getElementById('setEndPointButton').disabled = false;
            document.getElementById('instructionMessage').textContent = 'é–‹å§‹ç‚¹ã‚’åœ°å›³ä¸Šã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦è¨­å®šã—ã¦ãã ã•ã„ã€‚';
        });

        // ã€Œçµ‚äº†ç‚¹ã‚’é…ç½®ãƒ»ãƒ‰ãƒ©ãƒƒã‚°ã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('setEndPointButton').addEventListener('click', function() {
            if (!startPointMarker) {
                document.getElementById('instructionMessage').textContent = 'å…ˆã«é–‹å§‹ç‚¹ã‚’é…ç½®ã—ã¦ãã ã•ã„ã€‚';
                return;
            }

            if (!endPointMarker) {
                const center = map.getCenter();
                endPointMarker = L.marker(center, { draggable: true }).addTo(map);
                endPointMarker.on('dragend', onMarkerDragEnd);
                document.getElementById('startLineP2Lon').value = center.lng;
                document.getElementById('startLineP2Lat').value = center.lat;
                endPointMarker.bindPopup('çµ‚äº†ç‚¹<br>ç·¯åº¦: ' + center.lat.toFixed(6) + '<br>çµŒåº¦: ' + center.lng.toFixed(6)).openPopup();
            }
            map.setView(endPointMarker.getLatLng(), map.getZoom());
            updateStartLinePolyline();
            document.getElementById('instructionMessage').textContent = 'çµ‚äº†ç‚¹ã‚’åœ°å›³ä¸Šã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦è¨­å®šã—ã¦ãã ã•ã„ã€‚';
        });

        const circuitSelect = document.getElementById("circuitSelect");
        circuitSelect.addEventListener("change", function (e) {
            const stg = circuitSelect.value;
            const startLine = loadCircuitStartLineFromData(stg);
            document.getElementById('startLineP1Lon').value = startLine.p1[0];
            document.getElementById('startLineP1Lat').value = startLine.p1[1];
            document.getElementById('startLineP2Lon').value = startLine.p2[0];
            document.getElementById('startLineP2Lat').value = startLine.p2[1];
            cir1 = circuitData[stg]?.name || "";
            document.getElementById("setSportkk").textContent = cir1 || "æœªé¸æŠ";
            document.getElementById('setEndPointButton').disabled = false;
            localStorage.setItem('cir1', cir1);

            const p1 = L.latLng(startLine.p1[1], startLine.p1[0]);
            const p2 = L.latLng(startLine.p2[1], startLine.p2[0]);
            
            if (startPointMarker) {
                map.removeLayer(startPointMarker);
                startPointMarker = null;
            }
            if (endPointMarker) {
                map.removeLayer(endPointMarker);
                endPointMarker = null;
            }

            startPointMarker = L.marker(p1, { draggable: true }).addTo(map)
                .bindPopup('é–‹å§‹ç‚¹<br>ç·¯åº¦: ' + p1.lat.toFixed(6) + '<br>çµŒåº¦: ' + p1.lng.toFixed(6))
                .openPopup();
            startPointMarker.on('dragend', onMarkerDragEnd);

            endPointMarker = L.marker(p2, { draggable: true }).addTo(map)
                .bindPopup('çµ‚äº†ç‚¹<br>ç·¯åº¦: ' + p2.lat.toFixed(6) + '<br>çµŒåº¦: ' + p2.lng.toFixed(6))
                .openPopup();
            endPointMarker.on('dragend', onMarkerDragEnd);

            updateStartLinePolyline();
            map.fitBounds(L.latLngBounds(p1, p2).pad(0.5));
        });

        function saveStartLineCoordinates() {
            const p1Lon = parseFloat(document.getElementById('startLineP1Lon').value);
            const p1Lat = parseFloat(document.getElementById('startLineP1Lat').value);
            const p2Lon = parseFloat(document.getElementById('startLineP2Lon').value);
            const p2Lat = parseFloat(document.getElementById('startLineP2Lat').value);

            if (!isNaN(p1Lon) && !isNaN(p1Lat) && !isNaN(p2Lon) && !isNaN(p2Lat)) {
                localStorage.setItem('startLineP1Lon', p1Lon);
                localStorage.setItem('startLineP1Lat', p1Lat);
                localStorage.setItem('startLineP2Lon', p2Lon);
                localStorage.setItem('startLineP2Lat', p2Lat);
                document.getElementById('instructionMessage').textContent = 'ã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³åº§æ¨™ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚';
                loadStoredStartLineCoordinates();
            } else {
                document.getElementById('instructionMessage').textContent = 'æ­£ã—ã„æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
            }
        }

        const pulseCountSelect = document.getElementById("pulseCountSelect");
        pulseCountSelect.addEventListener("change", function (e) {
            pl1 = Number(pulseCountSelect.value);
            document.getElementById("setSportkkk").textContent = pl1;
            localStorage.setItem('pl1', pl1);
        });

        function savePulseCount() {
            localStorage.setItem('pl1', pl1);
            document.getElementById('instructionMessage').textContent = 'ãƒ‘ãƒ«ã‚¹æ•°ã‚’ä¿å­˜ã—ã¾ã—ãŸ: ' + pl1;
        }

        const thresholdSelect = document.getElementById("thresholdSelect");
        thresholdSelect.addEventListener("change", function (e) {
            gpsThreshold = Number(thresholdSelect.value);
            document.getElementById("setThresholdValue").textContent = gpsThreshold + "m";
            localStorage.setItem('gpsThreshold', gpsThreshold);
        });

        function saveThreshold() {
            localStorage.setItem('gpsThreshold', gpsThreshold);
            document.getElementById('instructionMessage').textContent = 'GPSé–¾å€¤ã‚’ä¿å­˜ã—ã¾ã—ãŸ: ' + gpsThreshold + "m";
        }

        const lapCoolDownSelect = document.getElementById("lapCoolDownSelect");
        lapCoolDownSelect.addEventListener("change", function (e) {
            lapCoolDownTime = Number(lapCoolDownSelect.value);
            document.getElementById("setLapCoolDown").textContent = (lapCoolDownTime / 1000) + "ç§’";
            localStorage.setItem('lapCoolDownTime', lapCoolDownTime);
        });

        function saveLapCoolDown() {
            localStorage.setItem('lapCoolDownTime', lapCoolDownTime);
            document.getElementById('instructionMessage').textContent = 'ãƒ©ãƒƒãƒ—ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸ: ' + (lapCoolDownTime / 1000) + "ç§’";
        }


        function loadStoredStartLineCoordinates() {
            const slP1Lon = localStorage.getItem('startLineP1Lon');
            const slP1Lat = localStorage.getItem('startLineP1Lat');
            const slP2Lon = localStorage.getItem('startLineP2Lon');
            const slP2Lat = localStorage.getItem('startLineP2Lat');

            document.getElementById('startLineP1Lon').value = slP1Lon || '';
            document.getElementById('startLineP1Lat').value = slP1Lat || '';
            document.getElementById('startLineP2Lon').value = slP2Lon || '';
            document.getElementById('startLineP2Lat').value = slP2Lat || '';

            if (slP1Lon && slP1Lat && slP2Lon && slP2Lat) {
                const p1 = L.latLng(parseFloat(slP1Lat), parseFloat(slP1Lon));
                const p2 = L.latLng(parseFloat(slP2Lat), parseFloat(slP2Lon));
                document.getElementById('setEndPointButton').disabled = false;

                if (startPointMarker) {
                    map.removeLayer(startPointMarker);
                    startPointMarker = null;
                }
                if (endPointMarker) {
                    map.removeLayer(endPointMarker);
                    endPointMarker = null;
                }

                startPointMarker = L.marker(p1, { draggable: true }).addTo(map)
                    .bindPopup('ä¿å­˜ã•ã‚ŒãŸé–‹å§‹ç‚¹<br>ç·¯åº¦: ' + p1.lat.toFixed(6) + '<br>çµŒåº¦: ' + p1.lng.toFixed(6))
                    .openPopup();
                startPointMarker.on('dragend', onMarkerDragEnd);

                endPointMarker = L.marker(p2, { draggable: true }).addTo(map)
                    .bindPopup('ä¿å­˜ã•ã‚ŒãŸçµ‚äº†ç‚¹<br>ç·¯åº¦: ' + p2.lat.toFixed(6) + '<br>çµŒåº¦: ' + p2.lng.toFixed(6))
                    .openPopup();
                endPointMarker.on('dragend', onMarkerDragEnd);

                updateStartLinePolyline();
                console.log('ä¿å­˜ã•ã‚ŒãŸã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³åº§æ¨™ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', p1, p2);
            } else {
                document.getElementById('setEndPointButton').disabled = true;
                if (startPointMarker) {
                    map.removeLayer(startPointMarker);
                    startPointMarker = null;
                }
                if (endPointMarker) {
                    map.removeLayer(endPointMarker);
                    endPointMarker = null;
                }
                if (startLinePolyline) {
                    map.removeLayer(startLinePolyline);
                    startLinePolyline = null;
                }
                console.log('localStorageã«ã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³åº§æ¨™ã¯ä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            }
        }

        function loadStoredPulseCount() {
            const storedPulseCount = localStorage.getItem('pl1');
            if (storedPulseCount) {
                pl1 = Number(storedPulseCount);
                document.getElementById("pulseCountSelect").value = storedPulseCount;
                document.getElementById("setSportkkk").textContent = pl1;
                console.log('ä¿å­˜ã•ã‚ŒãŸãƒ‘ãƒ«ã‚¹æ•°ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', pl1);
            } else {
                pl1 = 1;
                document.getElementById("pulseCountSelect").value = 1;
                document.getElementById("setSportkkk").textContent = pl1;
                console.log('localStorageã«ãƒ‘ãƒ«ã‚¹æ•°ã¯ä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šã—ã¾ã—ãŸ:', pl1);
            }
        }

        function loadStoredThreshold() {
            const storedThreshold = localStorage.getItem('gpsThreshold');
            if (storedThreshold) {
                gpsThreshold = Number(storedThreshold);
                document.getElementById("thresholdSelect").value = storedThreshold;
                document.getElementById("setThresholdValue").textContent = gpsThreshold + "m";
                console.log('ä¿å­˜ã•ã‚ŒãŸGPSé–¾å€¤ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', gpsThreshold);
            } else {
                gpsThreshold = 20;
                document.getElementById("thresholdSelect").value = 20;
                document.getElementById("setThresholdValue").textContent = gpsThreshold + "m";
                console.log('localStorageã«GPSé–¾å€¤ã¯ä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šã—ã¾ã—ãŸ:', gpsThreshold);
            }
        }

        function loadStoredLapCoolDown() {
            const storedLapCoolDown = localStorage.getItem('lapCoolDownTime');
            if (storedLapCoolDown) {
                lapCoolDownTime = Number(storedLapCoolDown);
                document.getElementById("lapCoolDownSelect").value = storedLapCoolDown;
                document.getElementById("setLapCoolDown").textContent = (lapCoolDownTime / 1000) + "ç§’";
                console.log('ä¿å­˜ã•ã‚ŒãŸãƒ©ãƒƒãƒ—ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', lapCoolDownTime);
            } else {
                lapCoolDownTime = 30000;
                document.getElementById("lapCoolDownSelect").value = 30000;
                document.getElementById("setLapCoolDown").textContent = (lapCoolDownTime / 1000) + "ç§’";
                console.log('localStorageã«ãƒ©ãƒƒãƒ—ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã¯ä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šã—ã¾ã—ãŸ:', lapCoolDownTime);
            }
        }


        function loadStoredCircuit() {
            const storedCircuit = localStorage.getItem('cir1');
            const circuitSelectElement = document.getElementById("circuitSelect");
            if (storedCircuit) {
                cir1 = storedCircuit;
                const optionToSelect = Array.from(circuitSelectElement.options).find(option => option.text === storedCircuit);
                if (optionToSelect) {
                    circuitSelectElement.value = optionToSelect.value;
                    document.getElementById("setSportkk").textContent = cir1;
                    document.getElementById('setEndPointButton').disabled = false;
                } else {
                    circuitSelectElement.value = "";
                    document.getElementById("setSportkk").textContent = "æœªé¸æŠ";
                }
                console.log('ä¿å­˜ã•ã‚ŒãŸã‚µãƒ¼ã‚­ãƒƒãƒˆåã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', cir1);
            } else {
                circuitSelectElement.value = "";
                document.getElementById("setSportkk").textContent = "æœªé¸æŠ";
                console.log('localStorageã«ã‚µãƒ¼ã‚­ãƒƒãƒˆåã¯ä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            }
        }

        function loadCircuitStartLineFromData(circuitId) {
            // ã“ã®é–¢æ•°ã¯ circuit_data.js ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ã“ã¨ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚
            if (circuitData && circuitData[circuitId]) {
                return {
                    p1: circuitData[circuitId].startLineP1,
                    p2: circuitData[circuitId].startLineP2
                };
            } else {
                return { p1: [0, 0], p2: [0, 0] };
            }
        }

        let button2 = document.getElementById('mybtn2');
        button2.addEventListener('click', () => {
            open('test3_4_ana_555.html');
        });

        // Function to reset all stored data and update UI
        function resetStorageAndDisplay() {
            // confirm() ã®ä»£ã‚ã‚Šã«ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½¿ã†ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¾ã™
            if (confirm('ã™ã¹ã¦ã®ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('startLineP1Lon');
                localStorage.removeItem('startLineP1Lat');
                localStorage.removeItem('startLineP2Lon');
                localStorage.removeItem('startLineP2Lat');
                localStorage.removeItem('pl1');
                localStorage.removeItem('cir1');
                localStorage.removeItem('gpsThreshold');
                localStorage.removeItem('lapCoolDownTime');

                document.getElementById('startLineP1Lon').value = '';
                document.getElementById('startLineP1Lat').value = '';
                document.getElementById('startLineP2Lon').value = '';
                document.getElementById('startLineP2Lat').value = '';

                document.getElementById("circuitSelect").value = "";
                document.getElementById("setSportkk").textContent = "æœªé¸æŠ";
                document.getElementById("pulseCountSelect").value = "1";
                document.getElementById("setSportkkk").textContent = "1";
                document.getElementById("thresholdSelect").value = "20";
                document.getElementById("setThresholdValue").textContent = "20m";
                document.getElementById("lapCoolDownSelect").value = "30000";
                document.getElementById("setLapCoolDown").textContent = "30ç§’";
                document.getElementById('clickCoordinates').textContent = '';
                document.getElementById('instructionMessage').textContent = 'ã™ã¹ã¦ã®è¨­å®šãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚';
                document.getElementById('setEndPointButton').disabled = true;

                if (startPointMarker) {
                    map.removeLayer(startPointMarker);
                    startPointMarker = null;
                }
                if (endPointMarker) {
                    map.removeLayer(endPointMarker);
                    endPointMarker = null;
                }
                if (startLinePolyline) {
                    map.removeLayer(startLinePolyline);
                    startLinePolyline = null;
                }
                console.log('All stored data has been reset.');
            }
        }

        // Attach event listener to the reset button
        document.getElementById('resetStorageButton').addEventListener('click', resetStorageAndDisplay);

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
        window.onload = function () {
            initMap();
            startGpsFrequencyMonitor();
            loadStoredStartLineCoordinates();
            loadStoredPulseCount();
            loadStoredCircuit();
            loadStoredThreshold();
            loadStoredLapCoolDown();
        };
    </script>
</body>
</html>

