<!DOCTYPE html>
<html lang="ja">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta http-equiv="X-UA-Compatible" content="IE=edge">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>GPSè¨­å®šãƒ„ãƒ¼ãƒ«</title>
Â  Â  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="manifest" href="/manifest.json">
Â  Â  <style>
Â  Â  Â  Â  /* åœ°å›³ã‚³ãƒ³ãƒ†ãƒŠã®ç›¸å¯¾ä½ç½®æŒ‡å®š */
Â  Â  Â  Â  #map-container {
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* åœ°å›³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
Â  Â  Â  Â  #mapid {
Â  Â  Â  Â  Â  Â  height: 300px;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* åœ°å›³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
Â  Â  Â  Â  #map-controls {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 10px;
Â  Â  Â  Â  Â  Â  right: 10px;
Â  Â  Â  Â  Â  Â  z-index: 1000;
Â  Â  Â  Â  Â  Â  background-color: rgba(255, 255, 255, 0.8);
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* åœ°å›³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«å†…ã®ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
Â  Â  Â  Â  #map-controls button {
Â  Â  Â  Â  Â  Â  padding: 8px 12px;
Â  Â  Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  margin-right: 5px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
Â  Â  Â  Â  #map-controls button.active {
Â  Â  Â  Â  Â  Â  background-color: #007bff;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* bodyå…¨ä½“ã®ãƒ•ã‚©ãƒ³ãƒˆã¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: sans-serif;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* ãƒ•ã‚©ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
Â  Â  Â  Â  .form-group {
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* ãƒ•ã‚©ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®ãƒ©ãƒ™ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
Â  Â  Â  Â  .form-group label {
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  margin-bottom: 5px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* æ•°å€¤å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
Â  Â  Â  Â  .form-group input[type="number"],
        .form-group input[type="text"] { /* ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚è¿½åŠ  */
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  Â  Â  width: 200px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
Â  Â  Â  Â  .form-group select {
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  Â  Â  width: 200px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* ãƒ•ã‚©ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
Â  Â  Â  Â  .form-group button {
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  margin-right: 5px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* å„ç¨®è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
Â  Â  Â  Â  #setSportkk,
Â  Â  Â  Â  #setSportkkk,
Â  Â  Â  Â  #setThresholdValue,
Â  Â  Â  Â  #setLapCoolDown,
        #setNmeaSettings, /* NMEAè¨­å®šè¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’è¿½åŠ  */
Â  Â  Â  Â  #gps-frequency {
Â  Â  Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* ã‚¯ãƒªãƒƒã‚¯åº§æ¨™è¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ« */
Â  Â  Â  Â  #clickCoordinates {
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
Â  Â  Â  Â  #instructionMessage {
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  min-height: 20px;
Â  Â  Â  Â  }
Â  Â  </style>

<script>
if ('serviceWorker' in navigator) {
Â  window.addEventListener('load', () => {
Â  Â  navigator.serviceWorker.register('/service-worker.js')
Â  Â  Â  .then(registration => {
Â  Â  Â  Â  console.log('Service Worker registered! Scope:', registration.scope);
Â  Â  Â  })
Â  Â  Â  .catch(err => {
Â  Â  Â  Â  console.log('Service Worker registration failed:', err);
Â  Â  Â  });
Â  });
}
</script>


</head>
<body>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="circuitSelect">ã‚µãƒ¼ã‚­ãƒƒãƒˆã‚’é¸æŠ:</label>
Â  Â  Â  Â  <select name="cir" id="circuitSelect">
Â  Â  Â  Â  Â  Â  <option value="">ã‚µãƒ¼ã‚­ãƒƒãƒˆã‚’é¸æŠ</option>
Â  Â  Â  Â  Â  Â  <option value="0">ç™½ç³¸S</option>
Â  Â  Â  Â  Â  Â  <option value="1">å¯Œå£«C</option>
Â  Â  Â  Â  Â  Â  <option value="2">ã¤ã¾æ‹</option>
Â  Â  Â  Â  Â  Â  <option value="3">ä¸­äº•C</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <p id="setSportkk"></p>
Â  Â  </div>

Â  Â  <div id="map-container">
Â  Â  Â  Â  <div id="mapid"></div>
Â  Â  Â  Â  <div id="map-controls">
Â  Â  Â  Â  Â  Â  <button id="setStartPointButton">é–‹å§‹ç‚¹ã‚’é…ç½®</button>
Â  Â  Â  Â  Â  Â  <button id="setEndPointButton" disabled>çµ‚äº†ç‚¹ã‚’é…ç½®</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div class="form-group">
Â  Â  Â  Â  <p id="instructionMessage"></p>
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="startLineP1Lon">é–‹å§‹ç‚¹ çµŒåº¦:</label>
Â  Â  Â  Â  <input type="number" id="startLineP1Lon" placeholder="çµŒåº¦" readonly>
Â  Â  </div>
Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="startLineP1Lat">é–‹å§‹ç‚¹ ç·¯åº¦:</label>
Â  Â  Â  Â  <input type="number" id="startLineP1Lat" placeholder="ç·¯åº¦" readonly>
Â  Â  </div>
Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="startLineP2Lon">çµ‚äº†ç‚¹ çµŒåº¦:</label>
Â  Â  Â  Â  <input type="number" id="startLineP2Lon" placeholder="çµŒåº¦" readonly>
Â  Â  </div>
Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="startLineP2Lat">çµ‚äº†ç‚¹ ç·¯åº¦:</label>
Â  Â  Â  Â  <input type="number" id="startLineP2Lat" placeholder="ç·¯åº¦" readonly>
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <button onclick="saveStartLineCoordinates()">ã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³åº§æ¨™ã‚’ä¿å­˜</button>
Â  Â  </div>

    Â  Â  <hr>
Â  Â  <div class="form-group">
Â  Â  Â  Â  <h3>ğŸ“¡ NMEA/USBãƒ‡ãƒã‚¤ã‚¹è¨­å®š (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</h3>
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="vendorId">NMEA VENDOR ID (ä¾‹: 0x1A86):</label>
Â  Â  Â  Â  <input type="text" id="vendorId" placeholder="ä¾‹: 0x1A86">
Â  Â  </div>
Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="productId">NMEA PRODUCT ID (ä¾‹: 0x7523):</label>
Â  Â  Â  Â  <input type="text" id="productId" placeholder="ä¾‹: 0x7523">
Â  Â  Â  Â  <small>â€»IDã¯16é€²æ•°è¡¨è¨˜ã§å…¥åŠ›ã—ã¦ãã ã•ã„</small>
Â  Â  </div>
Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="interfaceNumber">INTERFACE NUMBER (ä¾‹: 0):</label>
Â  Â  Â  Â  <input type="number" id="interfaceNumber" placeholder="ä¾‹: 0">
Â  Â  </div>
Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="inEndpoint">IN ENDPOINT (ä¾‹: 1):</label>
Â  Â  Â  Â  <input type="number" id="inEndpoint" placeholder="ä¾‹: 1">
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <button onclick="saveNmeaSettings()">NMEA/USBè¨­å®šã‚’ä¿å­˜</button>
Â  Â  </div>
Â  Â  <div class="form-group">
Â  Â  Â  Â  <p id="setNmeaSettings"></p>
Â  Â  </div>
Â  Â  <hr>
    Â  Â  <div class="form-group">
Â  Â  Â  Â  <p>GPSæ›´æ–°é »åº¦: <span id="gps-frequency">è¨ˆæ¸¬ä¸­...</span> Hz</p>
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="pulseCountSelect">ãƒ‘ãƒ«ã‚¹æ•°:</label>
Â  Â  Â  Â  <select name="pl" id="pulseCountSelect">
Â  Â  Â  Â  Â  Â  <option value="1">1</option>
Â  Â  Â  Â  Â  Â  <option value="2">2</option>
Â  Â  Â  Â  Â  Â  <option value="4">4</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <p id="setSportkkk"></p>
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <button onclick="savePulseCount()">SET ãƒ‘ãƒ«ã‚¹æ•°</button>
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="thresholdSelect">GPSé–¾å€¤ (ãƒ¡ãƒ¼ãƒˆãƒ«):</label>
Â  Â  Â  Â  <select name="threshold" id="thresholdSelect">
Â  Â  Â  Â  Â  Â  <option value="10">10m</option>
Â  Â  Â  Â  Â  Â  <option value="15">15m</option>
Â  Â  Â  Â  Â  Â  <option value="20">20m</option>
Â  Â  Â  Â  Â  Â  <option value="25">25m</option>
Â  Â  Â  Â  Â  Â  <option value="30">30m</option>
Â  Â  Â  Â  Â  Â  <option value="40">40m</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <p id="setThresholdValue"></p>
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <button onclick="saveThreshold()">SET GPSé–¾å€¤</button>
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="lapCoolDownSelect">ãƒ©ãƒƒãƒ—ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ (ç§’):</label>
Â  Â  Â  Â  <select name="coolDown" id="lapCoolDownSelect">
Â  Â  Â  Â  Â  Â  <option value="20000">20ç§’</option>
Â  Â  Â  Â  Â  Â  <option value="30000">30ç§’</option>
Â  Â  Â  Â  Â  Â  <option value="40000">40ç§’</option>
Â  Â  Â  Â  Â  Â  <option value="50000">50ç§’</option>
Â  Â  Â  Â  Â  Â  <option value="60000">60ç§’</option>
Â  Â  Â  Â  Â  Â  <option value="90000">90ç§’</option>
Â  Â  Â  Â  Â  Â  <option value="122000">120ç§’</option>
Â  Â  Â  Â  Â  Â  <option value="180000">180ç§’</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <p id="setLapCoolDown"></p>
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <button onclick="saveLapCoolDown()">SET ãƒ©ãƒƒãƒ—ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³</button>
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <button value="START" id="mybtn2">START</button>
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <p id="clickCoordinates"></p>
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <button id="resetStorageButton">Reset All Settings</button>
Â  Â  </div>

Â  Â  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
Â  Â  <script src="circuit_data.js"></script>
Â  Â  <script>
Â  Â  Â  Â  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
Â  Â  Â  Â  var map;
Â  Â  Â  Â  var startPointMarker = null;
Â  Â  Â  Â  var endPointMarker = null;
Â  Â  Â  Â  var currentPositionMarker = null;
Â  Â  Â  Â  var startLinePolyline = null; // ã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³ã®ç·š
Â  Â  Â  Â  var pl1 = 1; // ãƒ‘ãƒ«ã‚¹æ•°
Â  Â  Â  Â  var cir1 = ""; // ã‚µãƒ¼ã‚­ãƒƒãƒˆå
Â  Â  Â  Â  var gpsThreshold = 20; // GPSé–¾å€¤ã®åˆæœŸå€¤
Â  Â  Â  Â  var lapCoolDownTime = 30000; // ãƒ©ãƒƒãƒ—ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æ™‚é–“ã®åˆæœŸå€¤ (ãƒŸãƒªç§’)

Â  Â  Â  Â  // GPSæ›´æ–°é »åº¦è¨ˆæ¸¬ç”¨ã®å¤‰æ•°
Â  Â  Â  Â  let lastTimestamp = 0;
Â  Â  Â  Â  let watchId = null;

Â  Â  Â  Â  // åœ°å›³ã®åˆæœŸåŒ–ï¼ˆç¾åœ¨ä½ç½®ã‚’ä½¿ç”¨ï¼‰
Â  Â  Â  Â  function initMap() {
Â  Â  Â  Â  Â  Â  map = L.map('mapid');
Â  Â  Â  Â  Â  Â  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
Â  Â  Â  Â  Â  Â  Â  Â  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
Â  Â  Â  Â  Â  Â  }).addTo(map);

Â  Â  Â  Â  Â  Â  // åœ°å›³ã®åˆæœŸä½ç½®ã‚’é©å½“ãªå ´æ‰€ã«è¨­å®šï¼ˆwatchPositionã§æ›´æ–°ã•ã‚Œã‚‹ï¼‰
Â  Â  Â  Â  Â  Â  map.setView([35.0, 139.0], 8);
Â  Â  Â  Â  }

Â  Â  Â  Â  // GPSã®æ›´æ–°é »åº¦ã¨ç¾åœ¨ä½ç½®ã‚’ç›£è¦–ã™ã‚‹é–¢æ•°
Â  Â  Â  Â  function startGpsFrequencyMonitor() {
Â  Â  Â  Â  Â  Â  // watchPosition ã®æˆåŠŸæ™‚ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
Â  Â  Â  Â  Â  Â  function watchSuccess(position) {
Â  Â  Â  Â  Â  Â  Â  Â  const currentTimestamp = position.timestamp;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // æœ€åˆã®ãƒ‡ãƒ¼ã‚¿å—ä¿¡æ™‚ä»¥å¤–
Â  Â  Â  Â  Â  Â  Â  Â  if (lastTimestamp !== 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const elapsedTime = currentTimestamp - lastTimestamp;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // æ›´æ–°é »åº¦ï¼ˆHzï¼‰ã‚’è¨ˆç®—ã—ã€è¡¨ç¤º
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const frequency = 1000 / elapsedTime;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('gps-frequency').textContent = frequency.toFixed(2);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  lastTimestamp = currentTimestamp;

Â  Â  Â  Â  Â  Â  Â  Â  // åœ°å›³ä¸Šã®ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°
Â  Â  Â  Â  Â  Â  Â  Â  const currentLatLng = L.latLng(position.coords.latitude, position.coords.longitude);
Â  Â  Â  Â  Â  Â  Â  Â  if (currentPositionMarker) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentPositionMarker.setLatLng(currentLatLng);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentPositionMarker = L.marker(currentLatLng).addTo(map);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  map.setView(currentLatLng, 16); // åˆå›å–å¾—æ™‚ã«ã‚ºãƒ¼ãƒ 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // watchPosition ã®å¤±æ•—æ™‚ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
Â  Â  Â  Â  Â  Â  function watchError(error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error(`ä½ç½®æƒ…å ±ã®å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.code} - ${error.message}`);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('gps-frequency').textContent = 'ã‚¨ãƒ©ãƒ¼';
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // watchPosition ã§é€£ç¶šçš„ãªä½ç½®æƒ…å ±ã®ç›£è¦–ã‚’é–‹å§‹
Â  Â  Â  Â  Â  Â  watchId = navigator.geolocation.watchPosition(watchSuccess, watchError, {
Â  Â  Â  Â  Â  Â  Â  Â  // ã“ã“ã§ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
Â  Â  Â  Â  Â  Â  Â  Â  enableHighAccuracy: true,
Â  Â  Â  Â  Â  Â  Â  Â  timeout: 5000,
Â  Â  Â  Â  Â  Â  Â  Â  maximumAge: 0
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  console.log('GPSæ›´æ–°é »åº¦ã®ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚');
Â  Â  Â  Â  }

Â  Â  Â  Â  // ãƒãƒ¼ã‚«ãƒ¼ã®ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
Â  Â  Â  Â  function onMarkerDragEnd(e) {
Â  Â  Â  Â  Â  Â  const marker = e.target;
Â  Â  Â  Â  Â  Â  const latlng = marker.getLatLng();

Â  Â  Â  Â  Â  Â  if (marker === startPointMarker) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('startLineP1Lon').value = latlng.lng;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('startLineP1Lat').value = latlng.lat;
Â  Â  Â  Â  Â  Â  Â  Â  marker.setPopupContent('é–‹å§‹ç‚¹<br>ç·¯åº¦: ' + latlng.lat.toFixed(6) + '<br>çµŒåº¦: ' + latlng.lng.toFixed(6)).openPopup();
Â  Â  Â  Â  Â  Â  Â  Â  console.log('é–‹å§‹ç‚¹ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦æ›´æ–°ã—ã¾ã—ãŸ:', latlng);
Â  Â  Â  Â  Â  Â  } else if (marker === endPointMarker) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('startLineP2Lon').value = latlng.lng;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('startLineP2Lat').value = latlng.lat;
Â  Â  Â  Â  Â  Â  Â  Â  marker.setPopupContent('çµ‚äº†ç‚¹<br>ç·¯åº¦: ' + latlng.lat.toFixed(6) + '<br>çµŒåº¦: ' + latlng.lng.toFixed(6)).openPopup();
Â  Â  Â  Â  Â  Â  Â  Â  console.log('çµ‚äº†ç‚¹ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦æ›´æ–°ã—ã¾ã—ãŸ:', latlng);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  updateStartLinePolyline(); // ç·šã‚’æ›´æ–°
Â  Â  Â  Â  }

Â  Â  Â  Â  // ã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³ã®ç·šã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
Â  Â  Â  Â  function updateStartLinePolyline() {
Â  Â  Â  Â  Â  Â  if (startLinePolyline) {
Â  Â  Â  Â  Â  Â  Â  Â  map.removeLayer(startLinePolyline);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (startPointMarker && endPointMarker) {
Â  Â  Â  Â  Â  Â  Â  Â  const p1 = startPointMarker.getLatLng();
Â  Â  Â  Â  Â  Â  Â  Â  const p2 = endPointMarker.getLatLng();
Â  Â  Â  Â  Â  Â  Â  Â  startLinePolyline = L.polyline([p1, p2], { color: 'red', weight: 5, opacity: 0.7 }).addTo(map);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // ã€Œé–‹å§‹ç‚¹ã‚’é…ç½®ãƒ»ãƒ‰ãƒ©ãƒƒã‚°ã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
Â  Â  Â  Â  document.getElementById('setStartPointButton').addEventListener('click', function() {
Â  Â  Â  Â  Â  Â  if (!startPointMarker) {
Â  Â  Â  Â  Â  Â  Â  Â  const center = map.getCenter();
Â  Â  Â  Â  Â  Â  Â  Â  startPointMarker = L.marker(center, { draggable: true }).addTo(map);
Â  Â  Â  Â  Â  Â  Â  Â  startPointMarker.on('dragend', onMarkerDragEnd);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('startLineP1Lon').value = center.lng;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('startLineP1Lat').value = center.lat;
Â  Â  Â  Â  Â  Â  Â  Â  startPointMarker.bindPopup('é–‹å§‹ç‚¹<br>ç·¯åº¦: ' + center.lat.toFixed(6) + '<br>çµŒåº¦: ' + center.lng.toFixed(6)).openPopup();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  map.setView(startPointMarker.getLatLng(), map.getZoom());
Â  Â  Â  Â  Â  Â  document.getElementById('setEndPointButton').disabled = false;
Â  Â  Â  Â  Â  Â  document.getElementById('instructionMessage').textContent = 'é–‹å§‹ç‚¹ã‚’åœ°å›³ä¸Šã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦è¨­å®šã—ã¦ãã ã•ã„ã€‚';
Â  Â  Â  Â  });

Â  Â  Â  Â  // ã€Œçµ‚äº†ç‚¹ã‚’é…ç½®ãƒ»ãƒ‰ãƒ©ãƒƒã‚°ã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
Â  Â  Â  Â  document.getElementById('setEndPointButton').addEventListener('click', function() {
Â  Â  Â  Â  Â  Â  if (!startPointMarker) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('instructionMessage').textContent = 'å…ˆã«é–‹å§‹ç‚¹ã‚’é…ç½®ã—ã¦ãã ã•ã„ã€‚';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (!endPointMarker) {
Â  Â  Â  Â  Â  Â  Â  Â  const center = map.getCenter();
Â  Â  Â  Â  Â  Â  Â  Â  endPointMarker = L.marker(center, { draggable: true }).addTo(map);
Â  Â  Â  Â  Â  Â  Â  Â  endPointMarker.on('dragend', onMarkerDragEnd);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('startLineP2Lon').value = center.lng;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('startLineP2Lat').value = center.lat;
Â  Â  Â  Â  Â  Â  Â  Â  endPointMarker.bindPopup('çµ‚äº†ç‚¹<br>ç·¯åº¦: ' + center.lat.toFixed(6) + '<br>çµŒåº¦: ' + center.lng.toFixed(6)).openPopup();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  map.setView(endPointMarker.getLatLng(), map.getZoom());
Â  Â  Â  Â  Â  Â  updateStartLinePolyline();
Â  Â  Â  Â  Â  Â  document.getElementById('instructionMessage').textContent = 'çµ‚äº†ç‚¹ã‚’åœ°å›³ä¸Šã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦è¨­å®šã—ã¦ãã ã•ã„ã€‚';
Â  Â  Â  Â  });

Â  Â  Â  Â  const circuitSelect = document.getElementById("circuitSelect");
Â  Â  Â  Â  circuitSelect.addEventListener("change", function (e) {
Â  Â  Â  Â  Â  Â  const stg = circuitSelect.value;
Â  Â  Â  Â  Â  Â  const startLine = loadCircuitStartLineFromData(stg);
Â  Â  Â  Â  Â  Â  document.getElementById('startLineP1Lon').value = startLine.p1[0];
Â  Â  Â  Â  Â  Â  document.getElementById('startLineP1Lat').value = startLine.p1[1];
Â  Â  Â  Â  Â  Â  document.getElementById('startLineP2Lon').value = startLine.p2[0];
Â  Â  Â  Â  Â  Â  document.getElementById('startLineP2Lat').value = startLine.p2[1];
Â  Â  Â  Â  Â  Â  cir1 = circuitData[stg]?.name || "";
Â  Â  Â  Â  Â  Â  document.getElementById("setSportkk").textContent = cir1 || "æœªé¸æŠ";
Â  Â  Â  Â  Â  Â  document.getElementById('setEndPointButton').disabled = false;
Â  Â  Â  Â  Â  Â  localStorage.setItem('cir1', cir1);

Â  Â  Â  Â  Â  Â  const p1 = L.latLng(startLine.p1[1], startLine.p1[0]);
Â  Â  Â  Â  Â  Â  const p2 = L.latLng(startLine.p2[1], startLine.p2[0]);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (startPointMarker) {
Â  Â  Â  Â  Â  Â  Â  Â  map.removeLayer(startPointMarker);
Â  Â  Â  Â  Â  Â  Â  Â  startPointMarker = null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (endPointMarker) {
Â  Â  Â  Â  Â  Â  Â  Â  map.removeLayer(endPointMarker);
Â  Â  Â  Â  Â  Â  Â  Â  endPointMarker = null;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  startPointMarker = L.marker(p1, { draggable: true }).addTo(map)
Â  Â  Â  Â  Â  Â  Â  Â  .bindPopup('é–‹å§‹ç‚¹<br>ç·¯åº¦: ' + p1.lat.toFixed(6) + '<br>çµŒåº¦: ' + p1.lng.toFixed(6))
Â  Â  Â  Â  Â  Â  Â  Â  .openPopup();
Â  Â  Â  Â  Â  Â  startPointMarker.on('dragend', onMarkerDragEnd);

Â  Â  Â  Â  Â  Â  endPointMarker = L.marker(p2, { draggable: true }).addTo(map)
Â  Â  Â  Â  Â  Â  Â  Â  .bindPopup('çµ‚äº†ç‚¹<br>ç·¯åº¦: ' + p2.lat.toFixed(6) + '<br>çµŒåº¦: ' + p2.lng.toFixed(6))
Â  Â  Â  Â  Â  Â  Â  Â  .openPopup();
Â  Â  Â  Â  Â  Â  endPointMarker.on('dragend', onMarkerDragEnd);

Â  Â  Â  Â  Â  Â  updateStartLinePolyline();
Â  Â  Â  Â  Â  Â  map.fitBounds(L.latLngBounds(p1, p2).pad(0.5));
Â  Â  Â  Â  });

Â  Â  Â  Â  function saveStartLineCoordinates() {
Â  Â  Â  Â  Â  Â  const p1Lon = parseFloat(document.getElementById('startLineP1Lon').value);
Â  Â  Â  Â  Â  Â  const p1Lat = parseFloat(document.getElementById('startLineP1Lat').value);
Â  Â  Â  Â  Â  Â  const p2Lon = parseFloat(document.getElementById('startLineP2Lon').value);
Â  Â  Â  Â  Â  Â  const p2Lat = parseFloat(document.getElementById('startLineP2Lat').value);

Â  Â  Â  Â  Â  Â  if (!isNaN(p1Lon) && !isNaN(p1Lat) && !isNaN(p2Lon) && !isNaN(p2Lat)) {
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('startLineP1Lon', p1Lon);
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('startLineP1Lat', p1Lat);
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('startLineP2Lon', p2Lon);
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('startLineP2Lat', p2Lat);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('instructionMessage').textContent = 'ã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³åº§æ¨™ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚';
Â  Â  Â  Â  Â  Â  Â  Â  loadStoredStartLineCoordinates();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('instructionMessage').textContent = 'æ­£ã—ã„æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

        // â˜… NMEA/USBè¨­å®šã‚’ä¿å­˜ã™ã‚‹é–¢æ•° (æ–°è¦è¿½åŠ ) â˜…
        function saveNmeaSettings() {
            const vendorId = document.getElementById('vendorId').value.trim();
            const productId = document.getElementById('productId').value.trim();
            const interfaceNumber = document.getElementById('interfaceNumber').value.trim();
            const inEndpoint = document.getElementById('inEndpoint').value.trim();

            localStorage.setItem('vendorId', vendorId);
            localStorage.setItem('productId', productId);
            localStorage.setItem('interfaceNumber', interfaceNumber);
            localStorage.setItem('inEndpoint', inEndpoint);
            
            // è¡¨ç¤ºã‚’æ›´æ–°
            document.getElementById('setNmeaSettings').textContent = `
                VID: ${vendorId || 'æœªè¨­å®š'}, PID: ${productId || 'æœªè¨­å®š'}, IF: ${interfaceNumber || 'æœªè¨­å®š'}, EP: ${inEndpoint || 'æœªè¨­å®š'} ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚
            `;
            document.getElementById('instructionMessage').textContent = 'NMEA/USBãƒ‡ãƒã‚¤ã‚¹è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚';
        }
        // â˜… NMEA/USBè¨­å®šã‚’ä¿å­˜ã™ã‚‹é–¢æ•° (æ–°è¦è¿½åŠ ) ã“ã“ã¾ã§ â˜…


Â  Â  Â  Â  const pulseCountSelect = document.getElementById("pulseCountSelect");
Â  Â  Â  Â  pulseCountSelect.addEventListener("change", function (e) {
Â  Â  Â  Â  Â  Â  pl1 = Number(pulseCountSelect.value);
Â  Â  Â  Â  Â  Â  document.getElementById("setSportkkk").textContent = pl1;
Â  Â  Â  Â  Â  Â  localStorage.setItem('pl1', pl1);
Â  Â  Â  Â  });

Â  Â  Â  Â  function savePulseCount() {
Â  Â  Â  Â  Â  Â  localStorage.setItem('pl1', pl1);
Â  Â  Â  Â  Â  Â  document.getElementById('instructionMessage').textContent = 'ãƒ‘ãƒ«ã‚¹æ•°ã‚’ä¿å­˜ã—ã¾ã—ãŸ: ' + pl1;
Â  Â  Â  Â  }

Â  Â  Â  Â  const thresholdSelect = document.getElementById("thresholdSelect");
Â  Â  Â  Â  thresholdSelect.addEventListener("change", function (e) {
Â  Â  Â  Â  Â  Â  gpsThreshold = Number(thresholdSelect.value);
Â  Â  Â  Â  Â  Â  document.getElementById("setThresholdValue").textContent = gpsThreshold + "m";
Â  Â  Â  Â  Â  Â  localStorage.setItem('gpsThreshold', gpsThreshold);
Â  Â  Â  Â  });

Â  Â  Â  Â  function saveThreshold() {
Â  Â  Â  Â  Â  Â  localStorage.setItem('gpsThreshold', gpsThreshold);
Â  Â  Â  Â  Â  Â  document.getElementById('instructionMessage').textContent = 'GPSé–¾å€¤ã‚’ä¿å­˜ã—ã¾ã—ãŸ: ' + gpsThreshold + "m";
Â  Â  Â  Â  }

Â  Â  Â  Â  const lapCoolDownSelect = document.getElementById("lapCoolDownSelect");
Â  Â  Â  Â  lapCoolDownSelect.addEventListener("change", function (e) {
Â  Â  Â  Â  Â  Â  lapCoolDownTime = Number(lapCoolDownSelect.value);
Â  Â  Â  Â  Â  Â  document.getElementById("setLapCoolDown").textContent = (lapCoolDownTime / 1000) + "ç§’";
Â  Â  Â  Â  Â  Â  localStorage.setItem('lapCoolDownTime', lapCoolDownTime);
Â  Â  Â  Â  });

Â  Â  Â  Â  function saveLapCoolDown() {
Â  Â  Â  Â  Â  Â  localStorage.setItem('lapCoolDownTime', lapCoolDownTime);
Â  Â  Â  Â  Â  Â  document.getElementById('instructionMessage').textContent = 'ãƒ©ãƒƒãƒ—ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸ: ' + (lapCoolDownTime / 1000) + "ç§’";
Â  Â  Â  Â  }


Â  Â  Â  Â  function loadStoredStartLineCoordinates() {
Â  Â  Â  Â  Â  Â  const slP1Lon = localStorage.getItem('startLineP1Lon');
Â  Â  Â  Â  Â  Â  const slP1Lat = localStorage.getItem('startLineP1Lat');
Â  Â  Â  Â  Â  Â  const slP2Lon = localStorage.getItem('startLineP2Lon');
Â  Â  Â  Â  Â  Â  const slP2Lat = localStorage.getItem('startLineP2Lat');

Â  Â  Â  Â  Â  Â  document.getElementById('startLineP1Lon').value = slP1Lon || '';
Â  Â  Â  Â  Â  Â  document.getElementById('startLineP1Lat').value = slP1Lat || '';
Â  Â  Â  Â  Â  Â  document.getElementById('startLineP2Lon').value = slP2Lon || '';
Â  Â  Â  Â  Â  Â  document.getElementById('startLineP2Lat').value = slP2Lat || '';

Â  Â  Â  Â  Â  Â  if (slP1Lon && slP1Lat && slP2Lon && slP2Lat) {
Â  Â  Â  Â  Â  Â  Â  Â  const p1 = L.latLng(parseFloat(slP1Lat), parseFloat(slP1Lon));
Â  Â  Â  Â  Â  Â  Â  Â  const p2 = L.latLng(parseFloat(slP2Lat), parseFloat(slP2Lon));
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('setEndPointButton').disabled = false;

Â  Â  Â  Â  Â  Â  Â  Â  if (startPointMarker) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  map.removeLayer(startPointMarker);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startPointMarker = null;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (endPointMarker) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  map.removeLayer(endPointMarker);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  endPointMarker = null;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  startPointMarker = L.marker(p1, { draggable: true }).addTo(map)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .bindPopup('ä¿å­˜ã•ã‚ŒãŸé–‹å§‹ç‚¹<br>ç·¯åº¦: ' + p1.lat.toFixed(6) + '<br>çµŒåº¦: ' + p1.lng.toFixed(6))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .openPopup();
Â  Â  Â  Â  Â  Â  Â  Â  startPointMarker.on('dragend', onMarkerDragEnd);

Â  Â  Â  Â  Â  Â  Â  Â  endPointMarker = L.marker(p2, { draggable: true }).addTo(map)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .bindPopup('ä¿å­˜ã•ã‚ŒãŸçµ‚äº†ç‚¹<br>ç·¯åº¦: ' + p2.lat.toFixed(6) + '<br>çµŒåº¦: ' + p2.lng.toFixed(6))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .openPopup();
Â  Â  Â  Â  Â  Â  Â  Â  endPointMarker.on('dragend', onMarkerDragEnd);

Â  Â  Â  Â  Â  Â  Â  Â  updateStartLinePolyline();
Â  Â  Â  Â  Â  Â  Â  Â  console.log('ä¿å­˜ã•ã‚ŒãŸã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³åº§æ¨™ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', p1, p2);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('setEndPointButton').disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  if (startPointMarker) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  map.removeLayer(startPointMarker);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startPointMarker = null;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (endPointMarker) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  map.removeLayer(endPointMarker);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  endPointMarker = null;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (startLinePolyline) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  map.removeLayer(startLinePolyline);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startLinePolyline = null;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  console.log('localStorageã«ã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³åº§æ¨™ã¯ä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

        // â˜… ä¿å­˜ã•ã‚ŒãŸNMEA/USBè¨­å®šã‚’èª­ã¿è¾¼ã‚€é–¢æ•° (æ–°è¦è¿½åŠ ) â˜…
        function loadStoredNmeaSettings() {
            const vendorId = localStorage.getItem('vendorId') || '';
            const productId = localStorage.getItem('productId') || '';
            const interfaceNumber = localStorage.getItem('interfaceNumber') || '';
            const inEndpoint = localStorage.getItem('inEndpoint') || '';

            document.getElementById('vendorId').value = vendorId;
            document.getElementById('productId').value = productId;
            document.getElementById('interfaceNumber').value = interfaceNumber;
            document.getElementById('inEndpoint').value = inEndpoint;

            const displayContent = (vendorId || productId || interfaceNumber || inEndpoint) 
                ? `ç¾åœ¨ã®è¨­å®š - VID: ${vendorId}, PID: ${productId}, IF: ${interfaceNumber}, EP: ${inEndpoint}`
                : 'ç¾åœ¨ã®è¨­å®š - ãªã—';
                
            document.getElementById('setNmeaSettings').textContent = displayContent;
            
            if (vendorId || productId || interfaceNumber || inEndpoint) {
                console.log('ä¿å­˜ã•ã‚ŒãŸNMEA/USBè¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚');
            }
        }
        // â˜… ä¿å­˜ã•ã‚ŒãŸNMEA/USBè¨­å®šã‚’èª­ã¿è¾¼ã‚€é–¢æ•° (æ–°è¦è¿½åŠ ) ã“ã“ã¾ã§ â˜…

Â  Â  Â  Â  function loadStoredPulseCount() {
Â  Â  Â  Â  Â  Â  const storedPulseCount = localStorage.getItem('pl1');
Â  Â  Â  Â  Â  Â  if (storedPulseCount) {
Â  Â  Â  Â  Â  Â  Â  Â  pl1 = Number(storedPulseCount);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("pulseCountSelect").value = storedPulseCount;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("setSportkkk").textContent = pl1;
Â  Â  Â  Â  Â  Â  Â  Â  console.log('ä¿å­˜ã•ã‚ŒãŸãƒ‘ãƒ«ã‚¹æ•°ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', pl1);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  pl1 = 1;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("pulseCountSelect").value = 1;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("setSportkkk").textContent = pl1;
Â  Â  Â  Â  Â  Â  Â  Â  console.log('localStorageã«ãƒ‘ãƒ«ã‚¹æ•°ã¯ä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šã—ã¾ã—ãŸ:', pl1);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function loadStoredThreshold() {
Â  Â  Â  Â  Â  Â  const storedThreshold = localStorage.getItem('gpsThreshold');
Â  Â  Â  Â  Â  Â  if (storedThreshold) {
Â  Â  Â  Â  Â  Â  Â  Â  gpsThreshold = Number(storedThreshold);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("thresholdSelect").value = storedThreshold;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("setThresholdValue").textContent = gpsThreshold + "m";
Â  Â  Â  Â  Â  Â  Â  Â  console.log('ä¿å­˜ã•ã‚ŒãŸGPSé–¾å€¤ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', gpsThreshold);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  gpsThreshold = 20;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("thresholdSelect").value = 20;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("setThresholdValue").textContent = gpsThreshold + "m";
Â  Â  Â  Â  Â  Â  Â  Â  console.log('localStorageã«GPSé–¾å€¤ã¯ä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šã—ã¾ã—ãŸ:', gpsThreshold);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function loadStoredLapCoolDown() {
Â  Â  Â  Â  Â  Â  const storedLapCoolDown = localStorage.getItem('lapCoolDownTime');
Â  Â  Â  Â  Â  Â  if (storedLapCoolDown) {
Â  Â  Â  Â  Â  Â  Â  Â  lapCoolDownTime = Number(storedLapCoolDown);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("lapCoolDownSelect").value = storedLapCoolDown;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("setLapCoolDown").textContent = (lapCoolDownTime / 1000) + "ç§’";
Â  Â  Â  Â  Â  Â  Â  Â  console.log('ä¿å­˜ã•ã‚ŒãŸãƒ©ãƒƒãƒ—ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', lapCoolDownTime);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  lapCoolDownTime = 30000;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("lapCoolDownSelect").value = 30000;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("setLapCoolDown").textContent = (lapCoolDownTime / 1000) + "ç§’";
Â  Â  Â  Â  Â  Â  Â  Â  console.log('localStorageã«ãƒ©ãƒƒãƒ—ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã¯ä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šã—ã¾ã—ãŸ:', lapCoolDownTime);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  function loadStoredCircuit() {
Â  Â  Â  Â  Â  Â  const storedCircuit = localStorage.getItem('cir1');
Â  Â  Â  Â  Â  Â  const circuitSelectElement = document.getElementById("circuitSelect");
Â  Â  Â  Â  Â  Â  if (storedCircuit) {
Â  Â  Â  Â  Â  Â  Â  Â  cir1 = storedCircuit;
Â  Â  Â  Â  Â  Â  Â  Â  const optionToSelect = Array.from(circuitSelectElement.options).find(option => option.text === storedCircuit);
Â  Â  Â  Â  Â  Â  Â  Â  if (optionToSelect) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  circuitSelectElement.value = optionToSelect.value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("setSportkk").textContent = cir1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('setEndPointButton').disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  circuitSelectElement.value = "";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("setSportkk").textContent = "æœªé¸æŠ";
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  console.log('ä¿å­˜ã•ã‚ŒãŸã‚µãƒ¼ã‚­ãƒƒãƒˆåã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', cir1);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  circuitSelectElement.value = "";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("setSportkk").textContent = "æœªé¸æŠ";
Â  Â  Â  Â  Â  Â  Â  Â  console.log('localStorageã«ã‚µãƒ¼ã‚­ãƒƒãƒˆåã¯ä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function loadCircuitStartLineFromData(circuitId) {
Â  Â  Â  Â  Â  Â  // ã“ã®é–¢æ•°ã¯ circuit_data.js ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ã“ã¨ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚
Â  Â  Â  Â  Â  Â  if (circuitData && circuitData[circuitId]) {
Â  Â  Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  p1: circuitData[circuitId].startLineP1,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  p2: circuitData[circuitId].startLineP2
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  return { p1: [0, 0], p2: [0, 0] };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  let button2 = document.getElementById('mybtn2');
Â  Â  Â  Â  button2.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  open('test3_4_ana_555.html');
Â  Â  Â  Â  });

Â  Â  Â  Â  // Function to reset all stored data and update UI
Â  Â  Â  Â  function resetStorageAndDisplay() {
Â  Â  Â  Â  Â  Â  // confirm() ã®ä»£ã‚ã‚Šã«ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½¿ã†ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¾ã™
Â  Â  Â  Â  Â  Â  if (confirm('ã™ã¹ã¦ã®ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('startLineP1Lon');
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('startLineP1Lat');
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('startLineP2Lon');
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('startLineP2Lat');
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('pl1');
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('cir1');
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('gpsThreshold');
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('lapCoolDownTime');
                // â˜… NMEAè¨­å®šã®å‰Šé™¤ã‚’è¿½åŠ  â˜…
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('vendorId');
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('productId');
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('interfaceNumber');
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('inEndpoint');
                // â˜… NMEAè¨­å®šã®å‰Šé™¤ã“ã“ã¾ã§ â˜…

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('startLineP1Lon').value = '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('startLineP1Lat').value = '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('startLineP2Lon').value = '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('startLineP2Lat').value = '';

                // â˜… NMEAè¨­å®šã®UIã‚’ãƒªã‚»ãƒƒãƒˆ â˜…
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('vendorId').value = '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('productId').value = '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('interfaceNumber').value = '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('inEndpoint').value = '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('setNmeaSettings').textContent = '';
                // â˜… NMEAè¨­å®šã®UIãƒªã‚»ãƒƒãƒˆã“ã“ã¾ã§ â˜…

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("circuitSelect").value = "";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("setSportkk").textContent = "æœªé¸æŠ";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("pulseCountSelect").value = "1";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("setSportkkk").textContent = "1";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("thresholdSelect").value = "20";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("setThresholdValue").textContent = "20m";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("lapCoolDownSelect").value = "30000";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("setLapCoolDown").textContent = "30ç§’";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('clickCoordinates').textContent = '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('instructionMessage').textContent = 'ã™ã¹ã¦ã®è¨­å®šãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('setEndPointButton').disabled = true;

Â  Â  Â  Â  Â  Â  Â  Â  if (startPointMarker) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  map.removeLayer(startPointMarker);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startPointMarker = null;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (endPointMarker) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  map.removeLayer(endPointMarker);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  endPointMarker = null;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (startLinePolyline) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  map.removeLayer(startLinePolyline);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startLinePolyline = null;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  console.log('All stored data has been reset.');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Attach event listener to the reset button
Â  Â  Â  Â  document.getElementById('resetStorageButton').addEventListener('click', resetStorageAndDisplay);

Â  Â  Â  Â  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
Â  Â  Â  Â  window.onload = function () {
Â  Â  Â  Â  Â  Â  initMap();
Â  Â  Â  Â  Â  Â  startGpsFrequencyMonitor();
Â  Â  Â  Â  Â  Â  loadStoredStartLineCoordinates();
Â  Â  Â  Â  Â  Â  loadStoredPulseCount();
Â  Â  Â  Â  Â  Â  loadStoredCircuit();
Â  Â  Â  Â  Â  Â  loadStoredThreshold();
Â  Â  Â  Â  Â  Â  loadStoredLapCoolDown();
            // â˜… NMEAè¨­å®šã®èª­ã¿è¾¼ã¿ã‚’è¿½åŠ  â˜…
Â  Â  Â  Â  Â  Â  loadStoredNmeaSettings();
            // â˜… NMEAè¨­å®šã®èª­ã¿è¾¼ã¿ã“ã“ã¾ã§ â˜…
Â  Â  Â  Â  };
Â  Â  </script>
</body>
</html>
